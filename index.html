<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Retirement Planner</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked for Markdown Parsing in Chat -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Custom range slider styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #4F46E5;
            cursor: pointer;
            margin-top: -6px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #E5E7EB;
            border-radius: 2px;
        }
        
        /* Specific colors */
        .slider-acc::-webkit-slider-thumb { background: #4F46E5; } /* Indigo */
        .slider-ret::-webkit-slider-thumb { background: #10B981; } /* Emerald */
        .slider-ss::-webkit-slider-thumb { background: #F59E0B; } /* Amber */
        
        .scrolly-table::-webkit-scrollbar { width: 8px; height: 8px; }
        .scrolly-table::-webkit-scrollbar-track { background: #f1f1f1; }
        .scrolly-table::-webkit-scrollbar-thumb { background: #c7c7c7; border-radius: 4px; }

        /* Number Input Styling */
        .editable-num {
            background: transparent;
            border: none;
            border-bottom: 1px solid transparent;
            text-align: left; 
            width: 100%;
            font-weight: 700;
            padding: 0;
            transition: all 0.2s;
        }
        .editable-num:hover { border-bottom: 1px solid #cbd5e1; }
        .editable-num:focus { outline: none; border-bottom: 2px solid #4F46E5; background: #f8fafc; }
        .editable-num::-webkit-outer-spin-button,
        .editable-num::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        .modal-backdrop { background-color: rgba(15, 23, 42, 0.7); }
        
        /* Bucket Input Group */
        .bucket-label { font-size: 10px; font-weight: 700; text-transform: uppercase; color: #64748b; margin-bottom: 2px; }
        .bucket-input { width: 100%; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 4px; padding: 4px 8px; font-size: 12px; font-family: monospace; color: #334155; }
        .bucket-input:focus { outline: none; border-color: #6366f1; background: white; }

        /* Help Tooltip */
        #help-tooltip { pointer-events: none; transition: opacity 0.2s; }
        .help-mode-active { cursor: help !important; }
        .help-highlight::after { content: ''; position: absolute; top: -2px; left: -2px; right: -2px; bottom: -2px; border: 2px dashed #a5b4fc; border-radius: 6px; pointer-events: none; z-index: 10; }

        /* Chat Styling */
        .chat-bubble { max-width: 85%; padding: 8px 12px; border-radius: 12px; font-size: 13px; line-height: 1.4; margin-bottom: 8px; }
        .chat-user { background: #e0e7ff; color: #3730a3; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-ai { background: #f1f5f9; color: #334155; align-self: flex-start; border-bottom-left-radius: 2px; }
        .chat-system { font-size: 11px; color: #94a3b8; text-align: center; margin: 8px 0; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 font-sans min-h-screen flex flex-col relative">

    <!-- Help Tooltip -->
    <div id="help-tooltip" class="fixed hidden z-[9999] max-w-xs bg-slate-800 text-white text-xs p-3 rounded shadow-xl border border-slate-700">
        <div class="font-bold text-indigo-300 mb-1" id="help-title">Title</div>
        <div id="help-desc" class="opacity-90 leading-relaxed">Description</div>
    </div>

    <!-- Header -->
    <header class="bg-slate-900 text-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 sm:px-6 lg:px-8 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <svg class="w-8 h-8 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                <div>
                    <h1 class="text-lg sm:text-xl font-bold tracking-tight">Retirement Architect</h1>
                    <p class="text-slate-400 text-[10px] sm:text-xs">Tax-Aware Coast FIRE & Monte Carlo</p>
                </div>
            </div>
            
            <div class="text-right">
                <div class="flex justify-end items-center mb-1 gap-2">
                    <button onclick="app.toggleCopilot()" class="text-[10px] uppercase font-bold bg-gradient-to-r from-indigo-500 to-purple-600 text-white hover:from-indigo-600 hover:to-purple-700 rounded px-2 py-0.5 transition-all flex items-center gap-1 shadow-sm">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        AI Copilot
                    </button>
                    <button onclick="app.toggleHelpMode()" id="btn-help-mode" class="text-[10px] uppercase font-bold text-slate-400 hover:text-white border border-slate-600 rounded px-2 py-0.5 transition-colors flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Help
                    </button>
                    <input id="scenario-name" type="text" class="text-right bg-transparent border-b border-transparent hover:border-slate-500 focus:border-indigo-400 text-sm font-bold text-white w-32 sm:w-48 focus:outline-none placeholder-slate-500" placeholder="Scenario Name">
                </div>
                <div class="flex justify-end gap-3 text-[10px] text-indigo-300 font-medium">
                    <button onclick="app.saveToLocal()" class="hover:text-white transition-colors flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg> Save</button>
                    <button onclick="app.openLoadModal()" class="hover:text-white transition-colors flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg> Load</button>
                    <span class="text-slate-600">|</span>
                    <button onclick="app.exportJson()" class="hover:text-white transition-colors">Export</button>
                    <label class="hover:text-white transition-colors cursor-pointer">Import <input type="file" id="import-file" class="hidden" accept=".json" onchange="app.importJson(this)"></label>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="grid grid-cols-1 xl:grid-cols-12 gap-8">
            
            <!-- LEFT SIDEBAR: CONTROLS -->
            <div class="xl:col-span-4 space-y-6 h-fit">
                
                <!-- SECTION 1: PROFILE & ACCUMULATION -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5" data-help="profile">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 border-b pb-2">1. Profile & Timeline</h2>
                    <div class="space-y-6">
                        <!-- Timeline Config -->
                        <div class="grid grid-cols-3 gap-4">
                            <div data-help="age"><label class="text-[10px] uppercase font-bold text-slate-400 block mb-1">Start Age</label><input type="number" id="num-age" class="editable-num text-slate-700 text-xl"><input type="range" id="age" min="18" max="70" class="w-full slider-acc mt-2"></div>
                            <div data-help="stop-contrib"><label class="text-[10px] uppercase font-bold text-indigo-400 block mb-1">Stop Saving</label><input type="number" id="num-stopContribAge" class="editable-num text-indigo-600 text-xl"><input type="range" id="stopContribAge" min="25" max="80" class="w-full slider-acc mt-2"></div>
                            <div data-help="retire-age"><label class="text-[10px] uppercase font-bold text-emerald-500 block mb-1">Retire Age</label><input type="number" id="num-retireAge" class="editable-num text-emerald-600 text-xl"><input type="range" id="retireAge" min="40" max="80" class="w-full slider-ret mt-2"></div>
                        </div>

                        <!-- Asset Location -->
                        <div class="pt-2" data-help="buckets">
                            <div class="flex justify-between items-end mb-2">
                                <h3 class="text-xs font-bold text-slate-700">Portfolio Buckets</h3>
                                <span class="text-[10px] text-slate-400">Total: <span id="total-savings-display" class="font-mono text-indigo-600 font-bold">$0</span></span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 mb-4">
                                <div><label class="bucket-label text-orange-500">Taxable</label><input type="number" id="num-savingsTaxable" class="bucket-input" placeholder="0"></div>
                                <div><label class="bucket-label text-blue-500">Deferred</label><input type="number" id="num-savingsDeferred" class="bucket-input" placeholder="0"></div>
                                <div><label class="bucket-label text-emerald-500">Tax-Free</label><input type="number" id="num-savingsFree" class="bucket-input" placeholder="0"></div>
                            </div>
                            <div class="flex justify-between items-end mb-2">
                                <h3 class="text-xs font-bold text-slate-700">Annual Contribution</h3>
                                <span class="text-[10px] text-slate-400">Total: <span id="total-contrib-display" class="font-mono text-indigo-600 font-bold">$0</span></span>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <div><label class="bucket-label text-orange-500">Taxable</label><input type="number" id="num-contribTaxable" class="bucket-input" placeholder="0"></div>
                                <div><label class="bucket-label text-blue-500">Deferred</label><input type="number" id="num-contribDeferred" class="bucket-input" placeholder="0"></div>
                                <div><label class="bucket-label text-emerald-500">Tax-Free</label><input type="number" id="num-contribFree" class="bucket-input" placeholder="0"></div>
                            </div>
                        </div>

                        <!-- Macro Econ -->
                        <div class="space-y-4 pt-2 border-t border-slate-100">
                            <div data-help="return"><div class="flex justify-between text-xs font-semibold text-slate-600 mb-1 items-center"><span>Accumulation Return (%)</span><input type="number" id="num-return" class="editable-num text-indigo-600 text-right w-24" step="0.1"></div><input type="range" id="return" min="1" max="12" step="0.1" class="w-full slider-acc"></div>
                            <div data-help="volatility"><div class="flex justify-between text-xs font-semibold text-slate-600 mb-1 items-center"><span>Volatility / Std Dev (%)</span><input type="number" id="num-volatility" class="editable-num text-purple-600 text-right w-24" step="0.1"></div><input type="range" id="volatility" min="0" max="25" step="0.1" class="w-full slider-acc" style="accent-color: #9333ea;"></div>
                            <div data-help="inflation"><div class="flex justify-between text-xs font-semibold text-slate-600 mb-1 items-center"><span>Inflation (%)</span><input type="number" id="num-inflation" class="editable-num text-orange-500 text-right w-24" step="0.1"></div><input type="range" id="inflation" min="0" max="8" step="0.1" class="w-full slider-acc"></div>
                        </div>
                    </div>
                </div>

                <!-- SECTION 2: RETIREMENT & TAXES -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 border-b pb-2">2. Retirement & Taxes</h2>
                    <div class="space-y-4">
                        <div data-help="retire-return"><div class="flex justify-between text-xs font-semibold text-slate-600 mb-1 items-center"><span>Retirement Return (%)</span><input type="number" id="num-retireReturn" class="editable-num text-emerald-600 text-right w-24" step="0.1"></div><input type="range" id="retireReturn" min="0" max="10" step="0.1" class="w-full slider-ret"></div>
                        <div data-help="expenses"><div class="flex justify-between text-xs font-semibold text-slate-600 mb-1 items-center"><span>Annual Expenses (Net)</span><input type="number" id="num-expenses" class="editable-num text-emerald-600 text-right w-24" step="1000"></div><input type="range" id="expenses" min="20000" max="200000" step="1000" class="w-full slider-ret"></div>
                        <div class="bg-slate-50 p-3 rounded border border-slate-100 mt-2" data-help="tax-rates">
                            <p class="text-[10px] font-bold text-slate-500 uppercase mb-2">Tax Assumptions</p>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="text-[10px] font-bold text-blue-500 block mb-1">Income Tax Rate</label><div class="flex items-center"><input type="number" id="num-taxRateIncome" class="bg-white border border-slate-200 rounded text-xs p-1 w-12 text-center" value="20"><span class="text-xs text-slate-400 ml-1">%</span></div></div>
                                <div><label class="text-[10px] font-bold text-orange-500 block mb-1">Cap Gains Rate</label><div class="flex items-center"><input type="number" id="num-taxRateCap" class="bg-white border border-slate-200 rounded text-xs p-1 w-12 text-center" value="15"><span class="text-xs text-slate-400 ml-1">%</span></div></div>
                            </div>
                        </div>
                        <div class="mt-2" data-help="swr"><div class="flex justify-between text-xs font-semibold text-slate-600 mb-1 items-center"><span>Safe Withdrawal Rate (%)</span><input type="number" id="num-swr" class="editable-num text-emerald-600 text-right w-24" step="0.1"></div><input type="range" id="swr" min="2" max="6" step="0.1" class="w-full slider-ret"></div>
                    </div>
                </div>

                <!-- SECTION 3 & 4 (SS & Events) -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5" data-help="social-security">
                    <h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 border-b pb-2">3. Social Security</h2>
                    <div class="space-y-5">
                        <div><div class="flex justify-between text-xs font-semibold text-slate-600 mb-1 items-center"><span>Payout Ratio (%)</span><input type="number" id="num-ssHaircut" class="editable-num text-amber-600 text-right w-24"></div><input type="range" id="ssHaircut" min="50" max="100" step="1" class="w-full slider-ss"></div>
                        <div class="bg-slate-50 p-3 rounded border border-slate-100"><p class="text-xs font-bold text-slate-700 mb-2">You</p><div class="grid grid-cols-2 gap-3"><div><label class="text-[10px] font-semibold text-slate-500 block">Claim Age</label><input type="number" id="num-ssAge" class="editable-num text-amber-600 w-full text-left bg-transparent"><input type="range" id="ssAge" min="62" max="70" class="w-full slider-ss mt-1"></div><div><label class="text-[10px] font-semibold text-slate-500 block">Monthly $</label><input type="number" id="num-ssAmount" class="editable-num text-amber-600 w-full text-left bg-transparent"><input type="range" id="ssAmount" min="0" max="5000" step="100" class="w-full slider-ss mt-1"></div></div></div>
                        <div class="bg-slate-50 p-3 rounded border border-slate-100"><div class="flex justify-between items-center mb-2"><p class="text-xs font-bold text-slate-700">Spouse</p><div class="flex items-center space-x-2"><label class="text-[10px] text-slate-400">Current Age:</label><input type="number" id="num-ssSpouseCurrentAge" class="w-10 text-[10px] font-bold text-slate-600 border-b border-slate-200 focus:outline-none focus:border-indigo-500 text-center" value="35"></div></div><div class="grid grid-cols-2 gap-3"><div><label class="text-[10px] font-semibold text-slate-500 block">Claim Age</label><input type="number" id="num-ssSpouseAge" class="editable-num text-amber-600 w-full text-left bg-transparent"><input type="range" id="ssSpouseAge" min="62" max="70" class="w-full slider-ss mt-1"></div><div><label class="text-[10px] font-semibold text-slate-500 block">Monthly $</label><input type="number" id="num-ssSpouseAmount" class="editable-num text-amber-600 w-full text-left bg-transparent"><input type="range" id="ssSpouseAmount" min="0" max="5000" step="100" class="w-full slider-ss mt-1"></div></div></div>
                    </div>
                </div>

                 <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5" data-help="events">
                    <div class="flex justify-between items-center mb-4 border-b pb-2"><h2 class="text-xs font-bold text-slate-400 uppercase tracking-wider">4. Significant Cashflows</h2><button onclick="app.toggleEventForm()" class="text-xs bg-indigo-50 text-indigo-600 px-2 py-1 rounded font-bold hover:bg-indigo-100 transition-colors">+ Add</button></div>
                    <div id="event-form" class="hidden bg-slate-50 p-3 rounded border border-indigo-100 mb-3 space-y-3">
                        <div class="space-y-1"><label class="text-[10px] font-bold text-slate-500">Description</label><input type="text" id="evt-name" class="w-full text-xs border border-slate-200 rounded p-1" placeholder="e.g. College"></div>
                        <div class="flex gap-2"><div class="w-1/2 space-y-1"><label class="text-[10px] font-bold text-slate-500">Start Age</label><input type="number" id="evt-start" class="w-full text-xs border border-slate-200 rounded p-1"></div><div class="w-1/2 space-y-1"><label class="text-[10px] font-bold text-slate-500">End Age</label><input type="number" id="evt-end" class="w-full text-xs border border-slate-200 rounded p-1"></div></div>
                        <div class="space-y-1"><label class="text-[10px] font-bold text-slate-500">Annual Amount</label><input type="number" id="evt-amt" class="w-full text-xs border border-slate-200 rounded p-1" placeholder="Negative = Expense"></div>
                        <div class="flex gap-2 pt-1"><button onclick="app.addEvent()" class="flex-1 bg-indigo-600 text-white text-xs py-1.5 rounded font-bold hover:bg-indigo-700">Save</button><button onclick="app.toggleEventForm()" class="flex-1 bg-white border border-slate-300 text-slate-600 text-xs py-1.5 rounded hover:bg-slate-50">Cancel</button></div>
                    </div>
                    <div id="event-list" class="space-y-2"><p class="text-xs text-slate-400 text-center py-2">No custom events added.</p></div>
                </div>
            </div>

            <!-- RIGHT CONTENT -->
            <div class="xl:col-span-8 space-y-6">
                <!-- KPI Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="bg-indigo-600 rounded-xl p-4 text-white shadow-lg relative overflow-hidden" data-help="kpi-coast"><div class="relative z-10"><p class="text-indigo-200 text-[10px] font-bold uppercase tracking-wider">Projected Coast Ready</p><h3 class="text-2xl font-bold mt-1" id="res-coastAge">--</h3><p class="text-indigo-200 text-xs mt-1" id="res-coastDetails">Calculating...</p></div></div>
                    <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm" data-help="kpi-tipping"><p class="text-slate-500 text-[10px] font-bold uppercase tracking-wider">Tipping Point</p><h3 class="text-2xl font-bold text-slate-800 mt-1" id="res-tippingAge">--</h3><p class="text-slate-500 text-xs mt-1">Returns > Contributions</p></div>
                    <div class="bg-white border border-slate-200 rounded-xl p-4 shadow-sm" data-help="kpi-safe"><p class="text-slate-500 text-[10px] font-bold uppercase tracking-wider">Portfolio at Age 90</p><h3 class="text-2xl font-bold text-slate-800 mt-1" id="res-endPortfolio">--</h3><p class="text-slate-500 text-xs mt-1" id="res-endStatus">Safe?</p></div>
                </div>

                <!-- Main Chart -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-4">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                        <div class="flex items-center gap-4"><h3 class="text-lg font-bold text-slate-800" id="chart-title">Portfolio Balance</h3><div class="hidden sm:block text-xs bg-emerald-50 text-emerald-700 px-2 py-1 rounded border border-emerald-100" id="fi-number-display">FI Target: --</div></div>
                        <div class="bg-slate-100 p-1 rounded-lg flex text-xs font-medium">
                            <button onclick="setMode('balance')" id="btn-balance" class="px-3 py-1.5 rounded shadow-sm bg-white text-indigo-600 transition-all">Net Worth</button>
                            <button onclick="setMode('income')" id="btn-income" class="px-3 py-1.5 rounded text-slate-500 hover:text-slate-700 transition-all">Cashflow</button>
                            <button onclick="setMode('monteCarlo')" id="btn-monteCarlo" class="px-3 py-1.5 rounded text-slate-500 hover:text-slate-700 hover:bg-purple-50 hover:text-purple-600 transition-all flex items-center gap-1">Monte Carlo</button>
                        </div>
                    </div>
                    <div class="relative w-full h-80 bg-slate-50 rounded border border-slate-100" id="chart-container"><canvas id="mainChart"></canvas><div id="chart-tooltip" class="absolute hidden pointer-events-none bg-slate-800 text-white text-xs rounded px-2 py-1 shadow-lg z-20" style="top:0;left:0;"></div></div>
                    <div class="flex justify-center flex-wrap gap-4 mt-4 text-xs" id="chart-legend"></div>
                </div>

                <!-- Drawdown Table -->
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-5 py-3 border-b border-slate-100 flex justify-between items-center cursor-pointer bg-slate-50" onclick="document.getElementById('table-wrapper').classList.toggle('hidden')"><h3 class="text-sm font-bold text-slate-700">Yearly Breakdown Table</h3><span class="text-slate-400">â–¼</span></div>
                    <div id="table-wrapper" class="hidden">
                        <div class="flex justify-between items-center px-4 py-2 bg-slate-50 border-b border-slate-100">
                            <div class="text-[10px] text-slate-400 uppercase font-bold">Calculation Details</div>
                            <div class="flex gap-2"><button onclick="app.exportTableCsv()" class="text-[10px] uppercase font-bold text-slate-500 hover:text-indigo-600">CSV</button><button onclick="app.exportTableJson()" class="text-[10px] uppercase font-bold text-slate-500 hover:text-indigo-600">JSON</button></div>
                        </div>
                        <div class="overflow-x-auto max-h-80 scrolly-table"><table class="min-w-full text-xs text-left text-slate-600"><thead class="text-[10px] text-slate-500 uppercase bg-slate-100 sticky top-0"><tr><th class="px-4 py-2">Audit</th><th class="px-4 py-2">Age</th><th class="px-4 py-2">Year</th><th class="px-4 py-2">Phase</th><th class="px-4 py-2">Start Bal</th><th class="px-4 py-2 text-right">Net Flow</th><th class="px-4 py-2 text-right">Tax Paid</th><th class="px-4 py-2 text-right">Growth</th><th class="px-4 py-2 text-right">End Bal</th></tr></thead><tbody id="table-body" class="divide-y divide-slate-100"></tbody></table></div>
                    </div>
                </div>

                <!-- Analysis & MC Export -->
                 <div class="bg-indigo-50 border border-indigo-100 rounded-xl p-5 text-sm text-indigo-900 leading-relaxed relative">
                    <div id="analysis-text">Loading analysis...</div>
                    <div id="mc-export-container" class="hidden mt-4 pt-4 border-t border-indigo-100"><button onclick="app.exportMcCsv()" class="bg-purple-600 text-white text-xs px-3 py-2 rounded font-bold hover:bg-purple-700">Download Raw Simulation Data (CSV)</button></div>
                </div>
            </div>
        </div>
    </main>

    <!-- AI Copilot Modal -->
    <div id="copilot-modal" class="hidden fixed inset-0 z-[200] overflow-hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-slate-900/50 transition-opacity backdrop-blur-sm" onclick="app.toggleCopilot()"></div>
        
        <!-- Sidebar Drawer -->
        <div class="absolute inset-y-0 right-0 max-w-sm w-full flex">
            <div class="relative w-full h-full bg-white shadow-2xl flex flex-col transform transition-transform">
                
                <!-- Header -->
                <div class="bg-indigo-600 px-4 py-4 flex justify-between items-center text-white">
                    <div>
                        <h2 class="text-lg font-bold">AI Copilot</h2>
                        <p class="text-[10px] text-indigo-200">Describe your scenario in plain English.</p>
                    </div>
                    <button onclick="app.toggleCopilot()" class="text-indigo-200 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>

                <!-- Config (Key) -->
                <div class="bg-slate-50 p-4 border-b border-slate-200" id="api-config">
                    <label class="text-[10px] font-bold text-slate-500 uppercase block mb-1">OpenAI Compatible API Key</label>
                    <div class="flex gap-2">
                        <input type="password" id="api-key" class="flex-1 bg-white border border-slate-300 rounded text-xs px-2 py-1.5 focus:outline-none focus:border-indigo-500" placeholder="sk-...">
                        <button onclick="app.saveKey()" class="bg-white border border-slate-300 text-slate-600 text-xs px-3 rounded hover:bg-slate-100">Save</button>
                    </div>
                    <p class="text-[9px] text-slate-400 mt-1">Stored locally in your browser. Not sent to any server other than OpenAI.</p>
                </div>

                <!-- Chat Area -->
                <div class="flex-1 overflow-y-auto p-4 flex flex-col space-y-4 bg-slate-50" id="chat-history">
                    <div class="chat-system">Copilot Ready. Try: "I want to retire at 50 with 2M" or "Add a wedding expense of 30k at age 32"</div>
                </div>

                <!-- Input Area -->
                <div class="p-4 bg-white border-t border-slate-200">
                    <div class="relative">
                        <textarea id="chat-input" rows="2" class="w-full bg-slate-50 border border-slate-300 rounded-lg pl-3 pr-10 py-2 text-sm focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 resize-none" placeholder="Type your plan..."></textarea>
                        <button onclick="app.sendChat()" class="absolute right-2 bottom-2 text-indigo-500 hover:text-indigo-700">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load/Audit Modals (Keep existing structure) -->
    <div id="load-modal" class="hidden fixed inset-0 z-[100] overflow-y-auto"><div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"><div class="fixed inset-0 modal-backdrop" onclick="app.closeLoadModal()"></div><div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full"><div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4"><h3 class="text-lg leading-6 font-medium text-gray-900">Load Scenario</h3><ul id="scenario-list" class="mt-4 divide-y divide-slate-200 max-h-60 overflow-y-auto"></ul></div><div class="bg-slate-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse"><button class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" onclick="app.closeLoadModal()">Cancel</button></div></div></div></div>
    <div id="audit-modal" class="hidden fixed inset-0 z-[150] overflow-y-auto"><div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:p-0"><div class="fixed inset-0 modal-backdrop" onclick="document.getElementById('audit-modal').classList.add('hidden')"></div><div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full"><div class="bg-white px-4 pt-5 pb-4 sm:p-6"><div class="flex justify-between items-start border-b pb-2 mb-4"><h3 class="text-lg leading-6 font-bold text-gray-900" id="audit-title">Audit</h3><button onclick="document.getElementById('audit-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-500">X</button></div><div id="audit-content" class="text-xs font-mono text-slate-600 space-y-2 max-h-[60vh] overflow-y-auto"></div></div></div></div></div>

    <!-- App Logic -->
    <script>
        // --- Global App Namespace ---
        const app = {
            data: {},
            events: [], 
            elements: {},
            chart: null,
            scenarioName: "Unnamed Scenario",
            helpMode: false,
            apiKey: localStorage.getItem('fire_api_key') || '',
            helpData: {
                'profile': { title: "Profile", desc: "Basic timeline settings. Coast FIRE assumes you stop saving early but let your money grow until retirement." },
                'age': { title: "Current Age", desc: "Your age today. The simulation starts here." },
                'stop-contrib': { title: "Coast Age", desc: "The age you plan to stop adding new money to your portfolio. From this age until retirement, you live off your income but save nothing." },
                'retire-age': { title: "Retirement Age", desc: "The age you stop working completely and begin withdrawing from your portfolio." },
                'buckets': { title: "Tax Buckets", desc: "Assets are treated differently based on tax status. We withdraw from Taxable first, then Deferred (Income Tax), then Tax-Free (Roth)." },
                'return': { title: "Growth Rate", desc: "Annual investment return during your working and coasting years." },
                'volatility': { title: "Volatility", desc: "Used only in Monte Carlo mode. Determines how much returns fluctuate year-to-year (Standard Deviation). 15% is typical for stocks." },
                'inflation': { title: "Inflation", desc: "Annual increase in cost of living. All future values are adjusted by this rate." },
                'retire-return': { title: "Retirement Return", desc: "Usually lower than accumulation return to account for a more conservative asset allocation in retirement." },
                'expenses': { title: "Annual Expenses", desc: "Your desired spending in retirement, in today's dollars. This will be inflated automatically." },
                'tax-rates': { title: "Tax Rates", desc: "Estimated effective tax rates. Income Tax applies to 401k/IRA withdrawals. Cap Gains applies to ~50% of Brokerage withdrawals." },
                'swr': { title: "Safe Withdrawal Rate", desc: "The percentage of your portfolio you plan to withdraw annually. Used to calculate your 'FI Number' target and Coast Readiness." },
                'social-security': { title: "Social Security", desc: "Estimated benefits. 'Payout Ratio' allows you to model benefit cuts (e.g. 75%)." },
                'events': { title: "Cashflow Events", desc: "One-time large expenses (college, wedding) or windfalls (inheritance). Amounts are in today's dollars." },
                'kpi-coast': { title: "Coast Ready Age", desc: "The age at which your current portfolio is projected to grow large enough to support your spending, without any further contributions." },
                'kpi-tipping': { title: "Tipping Point", desc: "The age where your investment returns exceed your annual contributions." },
                'kpi-safe': { title: "Portfolio at 90", desc: "Projected remaining balance at age 90. If positive, your plan is successful." }
            }
        };
        
        // Initial Defaults
        const defaults = {
            age: 35,
            retireAge: 60,
            stopContribAge: 55, 
            savingsTaxable: 20000,
            savingsDeferred: 60000,
            savingsFree: 20000,
            contribTaxable: 5000,
            contribDeferred: 15000,
            contribFree: 5000,
            return: 8.0,
            retireReturn: 5.0,
            volatility: 12.0, 
            inflation: 3.0,
            expenses: 60000,
            taxRateIncome: 20,
            taxRateCap: 15,
            swr: 4.0,
            ssHaircut: 100,
            ssAge: 67,
            ssAmount: 2500,
            ssSpouseCurrentAge: 35,
            ssSpouseAge: 67,
            ssSpouseAmount: 0
        };

        const inputs = {}; 
        
        function bindInput(id, defaultValue) {
            if (['ssSpouseCurrentAge', 'savingsTaxable', 'savingsDeferred', 'savingsFree', 'contribTaxable', 'contribDeferred', 'contribFree', 'taxRateIncome', 'taxRateCap'].includes(id)) {
                const num = document.getElementById('num-' + id);
                if (num) { num.value = defaultValue; num.addEventListener('input', calculate); inputs[id] = { num }; }
                return;
            }
            const range = document.getElementById(id);
            const num = document.getElementById('num-' + id);
            if(!range || !num) return;
            range.value = defaultValue; num.value = defaultValue;
            range.addEventListener('input', (e) => { num.value = e.target.value; calculate(); });
            num.addEventListener('input', (e) => { range.value = e.target.value; calculate(); });
            inputs[id] = { range, num };
        }
        Object.keys(defaults).forEach(key => bindInput(key, defaults[key]));
        
        const nameInput = document.getElementById('scenario-name');
        nameInput.value = `Scenario ${new Date().toLocaleDateString()}`;
        app.scenarioName = nameInput.value;
        nameInput.addEventListener('input', (e) => app.scenarioName = e.target.value);

        // UI Refs
        const res = {
            coastAge: document.getElementById('res-coastAge'),
            coastDetails: document.getElementById('res-coastDetails'),
            tippingAge: document.getElementById('res-tippingAge'),
            endPortfolio: document.getElementById('res-endPortfolio'),
            endStatus: document.getElementById('res-endStatus'),
            analysis: document.getElementById('analysis-text'),
            chartLegend: document.getElementById('chart-legend'),
            chartTitle: document.getElementById('chart-title'),
            tableBody: document.getElementById('table-body'),
            totalSavings: document.getElementById('total-savings-display'),
            totalContrib: document.getElementById('total-contrib-display'),
            fiNumber: document.getElementById('fi-number-display')
        };

        const canvas = document.getElementById('mainChart');
        const ctx = canvas.getContext('2d');
        const tooltip = document.getElementById('chart-tooltip');

        let mode = 'balance'; 
        let chartData = [];
        let mcData = []; 

        const fmtMoney = (n) => {
            if (Math.abs(n) >= 1000000) return '$' + (n/1000000).toFixed(1) + 'M';
            if (Math.abs(n) >= 1000) return '$' + (n/1000).toFixed(0) + 'k';
            return '$' + n.toFixed(0);
        };
        const fmtFullMoney = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(n);

        // --- Core Functions (Existing) ---
        window.setMode = (m) => {
            mode = m;
            document.querySelectorAll('button[id^="btn-"]').forEach(b => {
                b.className = "px-3 py-1.5 rounded text-slate-500 hover:text-slate-700 transition-all";
                if(b.id === 'btn-monteCarlo') b.className += " flex items-center gap-1 hover:bg-purple-50 hover:text-purple-600";
            });
            const activeBtn = document.getElementById('btn-' + m);
            if(m === 'monteCarlo') {
                activeBtn.className = "px-3 py-1.5 rounded shadow-sm bg-purple-600 text-white font-bold transition-all flex items-center gap-1";
                res.chartTitle.innerText = "Monte Carlo Simulation (500 Runs)";
                document.getElementById('mc-export-container').classList.remove('hidden');
            } else {
                activeBtn.className = "px-3 py-1.5 rounded shadow-sm bg-white text-indigo-600 font-bold transition-all";
                if(m === 'balance') res.chartTitle.innerText = "Portfolio Balance (Sum of Buckets)";
                if(m === 'income') res.chartTitle.innerText = "Income vs Expenses";
                document.getElementById('mc-export-container').classList.add('hidden');
            }
            calculate(); 
        }

        // --- AI COPILOT LOGIC ---
        
        // Setup API Key
        document.getElementById('api-key').value = app.apiKey;
        app.saveKey = () => {
            const k = document.getElementById('api-key').value;
            localStorage.setItem('fire_api_key', k);
            app.apiKey = k;
            alert('Key Saved');
        };

        app.toggleCopilot = () => document.getElementById('copilot-modal').classList.toggle('hidden');

        app.addChatMessage = (role, text) => {
            const div = document.createElement('div');
            div.className = `chat-bubble ${role === 'user' ? 'chat-user' : 'chat-ai'}`;
            // Use marked for basic formatting in AI response
            div.innerHTML = role === 'user' ? text : marked.parse(text);
            document.getElementById('chat-history').appendChild(div);
            // Scroll to bottom
            const container = document.getElementById('chat-history');
            container.scrollTop = container.scrollHeight;
        };

        app.sendChat = async () => {
            const input = document.getElementById('chat-input');
            const prompt = input.value.trim();
            if (!prompt) return;
            if (!app.apiKey) return alert("Please enter your OpenAI API Key first.");

            app.addChatMessage('user', prompt);
            input.value = '';
            
            // Build Context
            // We strip out the large trajectory array to save tokens
            const currentContext = { ...app.data };
            delete currentContext.events; // Events are in app.events
            const contextData = {
                settings: currentContext,
                events: app.events
            };

            const systemPrompt = `
                You are the AI Copilot for a Retirement Planning App.
                Your goal is to modify the user's financial plan based on their natural language request.
                
                Current State (JSON):
                ${JSON.stringify(contextData)}

                INSTRUCTIONS:
                1. Analyze the user's request.
                2. Calculate any relative changes (e.g. "Increase savings by 10%").
                3. Return ONLY a valid JSON object containing the *updated* 'settings' and 'events' arrays.
                4. Do NOT explain your math. Do NOT return markdown formatting like \`\`\`json. Just the raw JSON.
                5. If adding events, give them unique IDs (Date.now() + random).
            `;

            app.addChatMessage('ai', '<span class="animate-pulse">Thinking...</span>');

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${app.apiKey}`
                    },
                    body: JSON.stringify({
                        model: "gpt-4-turbo-preview", // Or gpt-3.5-turbo
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: prompt }
                        ],
                        temperature: 0.2
                    })
                });

                const json = await response.json();
                
                if (json.error) {
                    throw new Error(json.error.message);
                }

                const aiText = json.choices[0].message.content;
                
                // Parse JSON from response (try to clean code blocks if model ignores instructions)
                let cleanJsonStr = aiText.replace(/```json/g, '').replace(/```/g, '').trim();
                const newData = JSON.parse(cleanJsonStr);

                // Update App
                if(newData.settings) app.loadData(newData.settings, null);
                if(newData.events) {
                    app.events = newData.events;
                    app.renderEventsList();
                    calculate();
                }

                // Remove loading msg
                const history = document.getElementById('chat-history');
                history.removeChild(history.lastChild);
                
                app.addChatMessage('ai', "Scenario updated successfully based on your request.");

            } catch (err) {
                const history = document.getElementById('chat-history');
                history.removeChild(history.lastChild);
                app.addChatMessage('ai', `Error: ${err.message}`);
            }
        };

        // Allow Enter to send
        document.getElementById('chat-input').addEventListener('keydown', (e) => {
            if(e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                app.sendChat();
            }
        });


        // --- Help Mode Logic ---
        app.toggleHelpMode = () => {
            app.helpMode = !app.helpMode;
            const btn = document.getElementById('btn-help-mode');
            if(app.helpMode) {
                btn.className = "text-[10px] uppercase font-bold bg-indigo-600 text-white border border-indigo-600 rounded px-2 py-0.5 transition-colors flex items-center gap-1";
                document.body.classList.add('help-mode-active');
            } else {
                btn.className = "text-[10px] uppercase font-bold text-slate-400 hover:text-white border border-slate-600 rounded px-2 py-0.5 transition-colors flex items-center gap-1";
                document.body.classList.remove('help-mode-active');
                document.getElementById('help-tooltip').classList.add('hidden');
            }
        };
        // Listeners
        document.addEventListener('mouseover', (e) => {
            if (!app.helpMode) return;
            const target = e.target.closest('[data-help]');
            if (target) {
                const key = target.getAttribute('data-help');
                const info = app.helpData[key];
                if (info) {
                    document.getElementById('help-title').innerText = info.title;
                    document.getElementById('help-desc').innerText = info.desc;
                    const tt = document.getElementById('help-tooltip');
                    tt.classList.remove('hidden');
                    const rect = target.getBoundingClientRect();
                    tt.style.top = (rect.bottom + 10) + 'px';
                    tt.style.left = Math.min(rect.left, window.innerWidth - 320) + 'px';
                    target.classList.add('help-highlight');
                }
            }
        });
        document.addEventListener('mouseout', (e) => {
            if (!app.helpMode) return;
            const target = e.target.closest('[data-help]');
            if (target) {
                document.getElementById('help-tooltip').classList.add('hidden');
                target.classList.remove('help-highlight');
            }
        });

        // --- Other logic (Event Mgmt, Sim) same as before ---
        
        app.toggleEventForm = () => document.getElementById('event-form').classList.toggle('hidden');
        app.addEvent = () => {
            const name = document.getElementById('evt-name').value;
            const start = parseInt(document.getElementById('evt-start').value);
            const end = parseInt(document.getElementById('evt-end').value);
            const amt = parseFloat(document.getElementById('evt-amt').value);
            if(!name || isNaN(start) || isNaN(end) || isNaN(amt)) return alert("Please fill all event fields correctly.");
            if(end < start) return alert("End age must be greater than or equal to start age.");
            app.events.push({ id: Date.now(), name, start, end, amt });
            document.getElementById('evt-name').value = "";
            document.getElementById('evt-start').value = "";
            document.getElementById('evt-end').value = "";
            document.getElementById('evt-amt').value = "";
            app.toggleEventForm();
            app.renderEventsList();
            calculate();
        };
        app.removeEvent = (id) => { app.events = app.events.filter(e => e.id !== id); app.renderEventsList(); calculate(); };
        app.renderEventsList = () => {
            const list = document.getElementById('event-list');
            if(app.events.length === 0) { list.innerHTML = `<p class="text-xs text-slate-400 text-center py-2">No custom events added.</p>`; return; }
            list.innerHTML = app.events.map(e => `
                <div class="flex justify-between items-center bg-slate-50 p-2 rounded border border-slate-100">
                    <div><div class="text-xs font-bold text-slate-700">${e.name}</div><div class="text-[10px] text-slate-400">Age ${e.start}-${e.end}</div></div>
                    <div class="text-right"><div class="text-xs font-mono font-bold ${e.amt >= 0 ? 'text-emerald-600' : 'text-red-500'}">${e.amt >= 0 ? '+' : ''}${fmtFullMoney(e.amt)}</div><button onclick="app.removeEvent(${e.id})" class="text-[9px] text-red-300 hover:text-red-500 underline">Remove</button></div>
                </div>`).join('');
        };

        function randn_bm() { let u=0,v=0; while(u===0)u=Math.random(); while(v===0)v=Math.random(); return Math.sqrt(-2.0*Math.log(u))*Math.cos(2.0*Math.PI*v); }

        function simulateTrajectory(p, useRandom = false, forceCoastFromAge = null) {
            const effectiveStopContrib = forceCoastFromAge !== null ? forceCoastFromAge : Math.min(p.stopContribAge, p.retireAge);
            const spouseAgeDiff = p.ssSpouseCurrentAge - p.age;
            let portTaxable = p.savingsTaxable, portDeferred = p.savingsDeferred, portFree = p.savingsFree;
            let cTax = p.contribTaxable, cDef = p.contribDeferred, cFree = p.contribFree;
            let expenses = p.expenses, age = p.age, year = new Date().getFullYear();
            let trajectory = [];
            const maxYears = 95 - p.age;
            const rAcc=p.return/100, rRet=p.retireReturn/100, vol=p.volatility/100, inf=p.inflation/100, haircut=p.ssHaircut/100, taxInc=p.taxRateIncome/100, taxCap=p.taxRateCap/100;
            let tippingAge = null;

            for (let i = 0; i <= maxYears; i++) {
                const startTaxable=portTaxable, startDeferred=portDeferred, startFree=portFree;
                const currentSpouseAge = age + spouseAgeDiff;
                const isRetired = age >= p.retireAge, isContributing = age < effectiveStopContrib, isCoasting = !isRetired && !isContributing;
                
                let rCurrent = isRetired ? rRet : rAcc;
                if (useRandom) rCurrent += (vol * randn_bm());
                
                portTaxable += portTaxable*rCurrent; portDeferred += portDeferred*rCurrent; portFree += portFree*rCurrent;
                const totalGrowth = (startTaxable*rCurrent) + (startDeferred*rCurrent) + (startFree*rCurrent);

                const yearsOfInf = year - new Date().getFullYear();
                const inflationFactor = Math.pow(1+inf, yearsOfInf);
                let userSS=0, spouseSS=0;
                if (age >= p.ssAge) userSS = (p.ssAmount*12)*inflationFactor;
                if (currentSpouseAge >= p.ssSpouseAge) spouseSS = (p.ssSpouseAmount*12)*inflationFactor;
                const ssTotal = (userSS+spouseSS)*haircut;

                let eventsSum=0, eventDetails=[];
                app.events.forEach(e => { if(age>=e.start && age<=e.end) { const v=e.amt*inflationFactor; eventsSum+=v; eventDetails.push(`${e.name}: ${fmtFullMoney(v)}`); } });

                let totalTaxPaid=0, netFlowDisplay=0, flow=0, withdrawTaxable=0, withdrawDeferred=0, withdrawFree=0;

                if (!isRetired) {
                    if (isContributing) {
                        portTaxable+=cTax; portDeferred+=cDef; portFree+=cFree;
                        let annualContrib = cTax+cDef+cFree; flow+=annualContrib;
                        if (!tippingAge && totalGrowth>annualContrib) tippingAge=age;
                    }
                    const extraCash = ssTotal + eventsSum; portTaxable+=extraCash; flow+=extraCash; netFlowDisplay=flow;
                    if (isContributing) { cTax*=(1+inf); cDef*=(1+inf); cFree*=(1+inf); }
                } else {
                    let gap = expenses - (ssTotal + eventsSum);
                    if (gap < 0) { portTaxable+=Math.abs(gap); flow+=Math.abs(gap); } 
                    else {
                        let remainingNeed = gap;
                        if (remainingNeed > 0 && portTaxable > 0) {
                            const effRate = 0.5 * taxCap; const gross = remainingNeed/(1-effRate); const w = Math.min(portTaxable, gross); const t=w*effRate;
                            withdrawTaxable=w; portTaxable-=w; remainingNeed-=(w-t); totalTaxPaid+=t; flow-=w;
                        }
                        if (remainingNeed > 0 && portDeferred > 0) {
                            const gross = remainingNeed/(1-taxInc); const w = Math.min(portDeferred, gross); const t=w*taxInc;
                            withdrawDeferred=w; portDeferred-=w; remainingNeed-=(w-t); totalTaxPaid+=t; flow-=w;
                        }
                        if (remainingNeed > 0 && portFree > 0) {
                            const w = Math.min(portFree, remainingNeed);
                            withdrawFree=w; portFree-=w; remainingNeed-=w; flow-=w;
                        }
                    }
                    netFlowDisplay = flow;
                }
                let totalPort = Math.max(0, portTaxable+portDeferred+portFree);
                trajectory.push({ age, year, startTaxable, startDeferred, startFree, endTaxable:portTaxable, endDeferred:portDeferred, endFree:portFree, growthTaxable:startTaxable*rCurrent, growthDeferred:startDeferred*rCurrent, growthFree:startFree*rCurrent, rCurrent, isRetired, isCoasting, expenses, ssTotal, eventsSum, eventDetails, drawdown:netFlowDisplay, totalTaxPaid, withdrawTaxable, withdrawDeferred, withdrawFree, inflationFactor, startPort:startTaxable+startDeferred+startFree, portfolio:totalPort, growth:totalGrowth });
                expenses*=(1+inf); age++; year++;
            }
            return { trajectory, tippingAge };
        }

        function checkCoastSWR(p, stopAge) {
            const sim = simulateTrajectory(p, false, stopAge);
            const retireData = sim.trajectory.find(d => d.age === p.retireAge);
            if(!retireData) return false;
            return (retireData.portfolio * (p.swr/100)) >= (retireData.expenses - retireData.ssTotal);
        }

        function calculate() {
            const getVal = (key) => parseFloat(inputs[key].num.value);
            const p = {};
            Object.keys(defaults).forEach(key => { p[key] = getVal(key); });
            app.data = { ...p, events: app.events }; 

            const totalStart = p.savingsTaxable + p.savingsDeferred + p.savingsFree;
            const totalContrib = p.contribTaxable + p.contribDeferred + p.contribFree;
            res.totalSavings.innerText = fmtMoney(totalStart); res.totalContrib.innerText = fmtMoney(totalContrib);

            const result = simulateTrajectory(p, false);
            chartData = result.trajectory;
            const port90 = chartData.find(d => d.age === 90)?.portfolio || 0;

            let foundCoastAge = null;
            if (mode !== 'monteCarlo') { for (let a = p.age; a <= p.retireAge; a++) { if (checkCoastSWR(p, a)) { foundCoastAge = a; break; } } }

            const fiNumber = p.expenses / (p.swr/100);
            res.fiNumber.innerText = `FI Target: ${fmtMoney(fiNumber)}`;

            mcData = []; let successCount = 0;
            if (mode === 'monteCarlo') {
                for(let i=0; i<500; i++) {
                    const sim = simulateTrajectory(p, true);
                    if (sim.trajectory.find(d => d.age === 90)?.portfolio > 0) successCount++;
                    mcData.push(sim.trajectory.map(d => d.portfolio)); 
                }
            }

            res.tippingAge.innerText = result.tippingAge ? `Age ${result.tippingAge}` : "Never";
            if (foundCoastAge !== null) {
                res.coastAge.innerText = foundCoastAge <= p.age ? "NOW" : `Age ${foundCoastAge}`;
                res.coastDetails.innerText = foundCoastAge <= p.age ? "Safe to Coast Today!" : `Can stop saving in ${foundCoastAge - p.age} yrs`;
                const isPlanSafe = p.stopContribAge >= foundCoastAge;
                res.coastAge.parentElement.parentElement.className = isPlanSafe ? "bg-emerald-600 rounded-xl p-4 text-white shadow-lg relative overflow-hidden" : "bg-orange-500 rounded-xl p-4 text-white shadow-lg relative overflow-hidden";
            } else {
                res.coastAge.innerText = "Never"; res.coastDetails.innerText = "Must save past retirement"; res.coastAge.parentElement.parentElement.className = "bg-slate-600 rounded-xl p-4 text-white shadow-lg relative overflow-hidden";
            }

            res.endPortfolio.innerText = fmtMoney(port90);
            if (mode === 'monteCarlo') {
                const successRate = (successCount/500)*100;
                res.endPortfolio.innerText = successRate.toFixed(1) + "%"; res.endStatus.innerText = "Success Rate (Age 90)";
                res.endPortfolio.parentElement.parentElement.className = "bg-purple-600 rounded-xl p-4 shadow-sm text-white";
                res.endPortfolio.className = "text-2xl font-bold text-white mt-1"; res.endStatus.className = "text-purple-200 text-xs mt-1";
                res.analysis.innerHTML = `<strong>Monte Carlo Simulation:</strong> Ran 500 scenarios with <strong>${p.volatility}%</strong> volatility.<br><br><span class="text-purple-600 font-bold">${successRate.toFixed(1)}%</span> success rate.`;
            } else {
                res.endPortfolio.parentElement.parentElement.className = "bg-white border border-slate-200 rounded-xl p-4 shadow-sm";
                res.endPortfolio.className = "text-2xl font-bold text-slate-800 mt-1";
                if (port90 > 0) { res.endStatus.innerText = "Safe: Has money at 90"; res.endStatus.className = "text-emerald-500 text-xs mt-1"; } 
                else { res.endStatus.innerText = "Warning: Depleted before 90"; res.endStatus.className = "text-red-500 text-xs mt-1"; }
                res.analysis.innerHTML = `<strong>${app.scenarioName} Strategy:</strong> Save until Age ${p.stopContribAge}, Coast until ${p.retireAge}.`;
            }
            renderChart(); renderTable();
        }

        // --- Charting ---
        function renderChart() {
            const container = document.getElementById('chart-container');
            canvas.width = container.clientWidth; canvas.height = container.clientHeight;
            const w=canvas.width, h=canvas.height, padding={top:20,right:20,bottom:30,left:50}, plotW=w-padding.left-padding.right, plotH=h-padding.top-padding.bottom;
            ctx.clearRect(0,0,w,h); if(chartData.length===0) return;

            let keys=[], maxY=0;
            if(mode==='monteCarlo') {
                const yearsCount=chartData.length, p10=[], p50=[], p90=[];
                for(let y=0; y<yearsCount; y++) {
                    const balances=mcData.map(run=>run[y]).sort((a,b)=>a-b);
                    p10.push(balances[Math.floor(balances.length*0.1)]); p50.push(balances[Math.floor(balances.length*0.5)]); p90.push(balances[Math.floor(balances.length*0.9)]);
                }
                maxY=Math.max(...p90)*1.1; drawGrid(maxY,w,h,padding);
                const drawLineArr = (arr, c, d=[]) => { ctx.beginPath(); ctx.strokeStyle=c; ctx.lineWidth=2; ctx.setLineDash(d); arr.forEach((val,i)=>{ const x=padding.left+(i/(arr.length-1))*plotW; const y=padding.top+plotH-((val/maxY)*plotH); if(i===0)ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.stroke(); ctx.setLineDash([]); };
                drawLineArr(p90,'#60a5fa',[5,5]); drawLineArr(p50,'#4f46e5'); drawLineArr(p10,'#10b981');
                drawXAxis(chartData,w,h,padding,plotW); res.chartLegend.innerHTML = `<div class="flex items-center gap-4"><span class="text-blue-400 font-bold">90th %</span><span class="text-indigo-600 font-bold">Median</span><span class="text-emerald-500 font-bold">10th %</span></div>`;
                return;
            }
            if(mode==='balance') keys=[{k:'portfolio',c:'#4F46E5',label:'Total Net Worth'}];
            else if(mode==='income') keys=[{k:'ssTotal',c:'#F59E0B',label:'SS Income'}, {k:'expenses',c:'#EF4444',label:'Expenses'}];
            else if(mode==='growth') keys=[{k:'growth',c:'#10B981',label:'Inv. Return'}, {k:'totalTaxPaid',c:'#EF4444',label:'Tax Paid'}];
            chartData.forEach(d=>{keys.forEach(k=>{if(d[k.k]>maxY)maxY=d[k.k];});}); maxY*=1.1; if(maxY===0)maxY=100;
            drawGrid(maxY,w,h,padding);
            keys.forEach(k=>{ ctx.beginPath(); ctx.strokeStyle=k.c; ctx.lineWidth=3; chartData.forEach((d,i)=>{ const x=padding.left+(i/(chartData.length-1))*plotW; const y=padding.top+plotH-((d[k.k]/maxY)*plotH); if(i===0)ctx.moveTo(x,y); else ctx.lineTo(x,y); }); ctx.stroke(); });
            drawXAxis(chartData,w,h,padding,plotW); res.chartLegend.innerHTML = keys.map(k=>`<div class="flex items-center"><span class="w-2 h-2 rounded-full mr-1" style="background:${k.c}"></span><span>${k.label}</span></div>`).join('');
            canvas.scaleInfo={chartData,padding,plotW,plotH,maxY};
        }
        function drawGrid(maxY,w,h,padding) { ctx.beginPath(); ctx.strokeStyle='#e2e8f0'; ctx.lineWidth=1; for(let i=0;i<=5;i++){ const yVal=(maxY/5)*i; const yPos=padding.top+(h-padding.top-padding.bottom)-((yVal/maxY)*(h-padding.top-padding.bottom)); ctx.moveTo(padding.left,yPos); ctx.lineTo(w-padding.right,yPos); ctx.fillStyle='#94a3b8'; ctx.font='10px sans-serif'; ctx.textAlign='right'; ctx.fillText(fmtMoney(yVal),padding.left-8,yPos+3); } ctx.stroke(); }
        function drawXAxis(data,w,h,padding,plotW) { ctx.textAlign='center'; ctx.fillStyle='#64748b'; data.forEach((d,i)=>{ if(i%5===0){ const x=padding.left+(i/(data.length-1))*plotW; ctx.fillText(d.age,x,h-padding.bottom+15); }}); }

        // --- Table ---
        function renderTable() {
            const html = chartData.map((d, index) => {
                let phaseLabel = d.isRetired ? "ðŸŒ´ Spend" : (d.isCoasting ? "âš“ Coast" : "ðŸ’° Save");
                let rowClass = d.isRetired ? (d.portfolio <= 0 ? "bg-red-50" : "bg-white") : "bg-slate-50";
                let flowVal = d.drawdown; let flowClass = d.isRetired ? (flowVal>=0 ? "text-emerald-600 font-bold" : "text-red-500 font-bold") : "text-indigo-600 font-bold";
                return `<tr class="${rowClass} border-b border-slate-100 hover:bg-slate-100 transition-colors"><td class="px-4 py-2 text-center"><button onclick="app.showAudit(${index})" class="text-slate-400 hover:text-indigo-600"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg></button></td><td class="px-4 py-2 font-medium">${d.age}</td><td class="px-4 py-2 text-slate-400">${d.year}</td><td class="px-4 py-2 text-[10px] uppercase font-bold text-slate-500">${phaseLabel}</td><td class="px-4 py-2 font-mono">${fmtMoney(d.startPort)}</td><td class="px-4 py-2 text-right font-mono ${flowClass}">${flowVal!==0?fmtMoney(flowVal):'-'}</td><td class="px-4 py-2 text-right font-mono text-red-400">${d.totalTaxPaid>0?'-'+fmtMoney(d.totalTaxPaid):'-'}</td><td class="px-4 py-2 text-right font-mono text-emerald-600">+${fmtMoney(d.growth)}</td><td class="px-4 py-2 text-right font-mono font-bold">${fmtMoney(d.portfolio)}</td></tr>`;
            }).join('');
            res.tableBody.innerHTML = html;
        }
        app.showAudit = (index) => {
            const d = chartData[index]; document.getElementById('audit-title').innerText = `Audit Log: Age ${d.age} (${d.year})`; document.getElementById('audit-modal').classList.remove('hidden');
            let html=`<div class="space-y-4"><div class="bg-slate-50 p-2 rounded"><h4 class="font-bold text-slate-700 mb-1 border-b border-slate-200">1. Starting Position</h4><div class="grid grid-cols-3 gap-2"><div>Taxable: ${fmtFullMoney(d.startTaxable)}</div><div>Deferred: ${fmtFullMoney(d.startDeferred)}</div><div>Tax-Free: ${fmtFullMoney(d.startFree)}</div></div><div class="mt-1 font-bold text-indigo-600">Total Start: ${fmtFullMoney(d.startPort)}</div></div><div class="bg-slate-50 p-2 rounded"><h4 class="font-bold text-slate-700 mb-1 border-b border-slate-200">2. Investment Growth (${(d.rCurrent*100).toFixed(2)}%)</h4><div class="grid grid-cols-3 gap-2"><div>+${fmtFullMoney(d.growthTaxable)}</div><div>+${fmtFullMoney(d.growthDeferred)}</div><div>+${fmtFullMoney(d.growthFree)}</div></div><div class="mt-1 font-bold text-emerald-600">Total Growth: +${fmtFullMoney(d.growth)}</div></div><div class="bg-slate-50 p-2 rounded"><h4 class="font-bold text-slate-700 mb-1 border-b border-slate-200">3. Cashflow Events</h4><div>Inflation Factor: ${d.inflationFactor.toFixed(3)}x</div><div>Expenses (Inflated): ${fmtFullMoney(d.expenses)}</div><div class="text-amber-600">Social Security (Household): +${fmtFullMoney(d.ssTotal)}</div>${d.eventDetails.length>0?`<div class="text-blue-500">Custom Events: ${d.eventDetails.join(', ')}</div>`:''}</div><div class="bg-slate-50 p-2 rounded"><h4 class="font-bold text-slate-700 mb-1 border-b border-slate-200">4. Net Flow Logic</h4><div class="text-slate-500 italic mb-1">${d.isRetired?"RETIRED: (Expenses - Income) withdrawn from portfolio":"WORKING: (Savings + Income) added to portfolio"}</div>${d.isRetired?`<div>Gap to Cover: ${fmtFullMoney(d.expenses)} - ${fmtFullMoney(d.ssTotal+d.eventsSum)} = <strong>${fmtFullMoney(d.expenses-(d.ssTotal+d.eventsSum))}</strong></div><div class="mt-2 text-slate-800 font-bold underline">Withdrawal Waterfall:</div><div class="grid grid-cols-2 gap-x-4 gap-y-1 mt-1"><div>Taxable Withdraw:</div><div class="text-right text-red-500">-${fmtFullMoney(d.withdrawTaxable)}</div><div>Deferred Withdraw:</div><div class="text-right text-red-500">-${fmtFullMoney(d.withdrawDeferred)}</div><div>Tax-Free Withdraw:</div><div class="text-right text-red-500">-${fmtFullMoney(d.withdrawFree)}</div><div class="border-t border-slate-300 pt-1">Total Tax Paid:</div><div class="text-right text-red-600 border-t border-slate-300 pt-1">-${fmtFullMoney(d.totalTaxPaid)}</div></div>`:`<div>Contributions + Extra Income: +${fmtFullMoney(d.drawdown)}</div>`}</div><div class="bg-indigo-50 p-2 rounded border border-indigo-100"><h4 class="font-bold text-indigo-800 mb-1">5. Ending Position</h4><div class="grid grid-cols-3 gap-2"><div>Taxable: ${fmtFullMoney(d.endTaxable)}</div><div>Deferred: ${fmtFullMoney(d.endDeferred)}</div><div>Tax-Free: ${fmtFullMoney(d.endFree)}</div></div><div class="mt-1 font-bold text-xl text-indigo-700">Total End: ${fmtFullMoney(d.portfolio)}</div></div></div>`;
            document.getElementById('audit-content').innerHTML=html;
        };

        // --- Save/Load (Existing) ---
        app.exportMcCsv=()=>{if(!mcData.length)return alert("Run simulation first!");const h=["Year","Age",...Array.from({length:mcData.length},(_,i)=>`Run_${i+1}`)];const r=chartData.map((d,i)=>[d.year,d.age,...mcData.map(run=>run[i].toFixed(2))].join(","));const c="data:text/csv;charset=utf-8,"+ [h.join(","),...r].join("\n");const l=document.createElement("a");l.href=encodeURI(c);l.download=`${app.scenarioName}_MonteCarlo_Raw.csv`;document.body.appendChild(l);l.click();l.remove();};
        app.exportTableCsv=()=>{if(!chartData.length)return;const h=["Age","Year","Phase","Start Balance","Net Flow","Tax Paid","Growth","End Balance"];const r=chartData.map(d=>[d.age,d.year,d.isRetired?"Retired":(d.isCoasting?"Coasting":"Accumulating"),d.startPort.toFixed(2),d.drawdown.toFixed(2),d.totalTaxPaid.toFixed(2),d.growth.toFixed(2),d.portfolio.toFixed(2)].join(","));const c="data:text/csv;charset=utf-8,"+ [h.join(","),...r].join("\n");const l=document.createElement("a");l.href=encodeURI(c);l.download=`${app.scenarioName}_Breakdown.csv`;document.body.appendChild(l);l.click();l.remove();};
        app.exportTableJson=()=>{if(!chartData.length)return;const s="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(chartData,null,2));const l=document.createElement('a');l.href=s;l.download=`${app.scenarioName}_Breakdown.json`;document.body.appendChild(l);l.click();l.remove();};
        app.exportJson=()=>{const d="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify({name:app.scenarioName,data:app.data},null,2));const n=document.createElement('a');n.href=d;n.download=`${app.scenarioName}.json`;document.body.appendChild(n);n.click();n.remove();};
        app.saveToLocal=()=>{const s=JSON.parse(localStorage.getItem('fire_scenarios')||'[]');s.push({id:Date.now(),name:app.scenarioName,date:new Date().toLocaleString(),data:app.data});localStorage.setItem('fire_scenarios',JSON.stringify(s));const b=document.activeElement;b.innerHTML=`<span class="text-emerald-400">Saved!</span>`;setTimeout(()=>b.innerHTML="Save",1500);};
        app.openLoadModal=()=>{const m=document.getElementById('load-modal');const l=document.getElementById('scenario-list');const s=JSON.parse(localStorage.getItem('fire_scenarios')||'[]');m.classList.remove('hidden');if(s.length===0){l.innerHTML=`<li class="py-4 text-center text-slate-500 text-sm">No saved scenarios.</li>`;return;}l.innerHTML=s.map(x=>`<li class="py-3 px-2 hover:bg-slate-50 flex justify-between items-center cursor-pointer" onclick="app.loadScenario(${x.id})"><div><div class="text-sm font-medium text-indigo-700">${x.name}</div><div class="text-xs text-slate-400">${x.date}</div></div><button onclick="event.stopPropagation(); app.deleteScenario(${x.id})" class="text-red-400 hover:text-red-600 text-xs">Delete</button></li>`).reverse().join('');};
        app.closeLoadModal=()=>document.getElementById('load-modal').classList.add('hidden');
        app.loadScenario=(id)=>{const s=JSON.parse(localStorage.getItem('fire_scenarios')).find(x=>x.id===id);if(s){app.loadData(s.data,s.name);app.closeLoadModal();}};
        app.deleteScenario=(id)=>{localStorage.setItem('fire_scenarios',JSON.stringify(JSON.parse(localStorage.getItem('fire_scenarios')).filter(x=>x.id!==id)));app.openLoadModal();};
        app.loadData=(data,name)=>{if(name){app.scenarioName=name;document.getElementById('scenario-name').value=name;}Object.keys(data).forEach(key=>{if(inputs[key]){if(inputs[key].range)inputs[key].range.value=data[key];if(inputs[key].num)inputs[key].num.value=data[key];}});app.events=data.events||[];app.renderEventsList();calculate();};
        app.importJson=(input)=>{const r=new FileReader();r.onload=(e)=>app.loadData(JSON.parse(e.target.result).data,JSON.parse(e.target.result).name);r.readAsText(input.files[0]);input.value='';};

        // Init
        app.renderEventsList();
        calculate();
        window.addEventListener('resize', renderChart);

    </script>
</body>
</html>
